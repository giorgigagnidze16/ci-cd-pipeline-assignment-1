name: Deploy Java App to Heroku

on:
  workflow_run:
    workflows: ["Java CI"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build with Maven
        run: mvn clean package

      - name: Set up Git credentials for Heroku
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "https://git:${{ secrets.HEROKU_API_KEY }}@git.heroku.com" > ~/.git-credentials
          git config --global credential.helper store

      - name: Deploy to Heroku Staging
        run: |
          git remote add staging https://git.heroku.com/my-java-app-staging.git
          git push staging `git subtree split --prefix . main`:refs/heads/main --force

      - name: Deploy to Heroku Production
        run: |
          git remote add prod https://git.heroku.com/my-java-app-prod.git
          git push prod `git subtree split --prefix . main`:refs/heads/main --force
